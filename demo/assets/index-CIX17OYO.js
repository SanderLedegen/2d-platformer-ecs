(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();const P=[{name:"wave",imagePath:"assets/wave.png"},{name:"grassFull",imagePath:"assets/grass-full.png"},{name:"groundFull",imagePath:"assets/ground-full.png"},{name:"groundSemiSolid",imagePath:"assets/ground-semi-solid.png"},{name:"grassFloat",imagePath:"assets/grass-float.png"},{name:"grassFloatLeft",imagePath:"assets/grass-float-left.png"},{name:"grassFloatRight",imagePath:"assets/grass-float-right.png"},{name:"sign",imagePath:"assets/sign.png"},{name:"box",imagePath:"assets/box.png"},{name:"playerIdle",imagePath:"assets/player-idle.png"},{name:"playerJump",imagePath:"assets/player-jump.png"},{name:"playerRun",imagePath:"assets/player-run.png"}],I=[{name:"wave",asset:"wave",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"grassFull",asset:"grassFull",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"groundFull",asset:"groundFull",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"groundSemiSolid",asset:"groundSemiSolid",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"grassFloat",asset:"grassFloat",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"grassFloatLeft",asset:"grassFloatLeft",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"grassFloatRight",asset:"grassFloatRight",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"sign",asset:"sign",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"box",asset:"box",numAnimFrames:1,singleFrameDuration:1,repeating:!0},{name:"playerIdle",asset:"playerIdle",numAnimFrames:4,singleFrameDuration:28,repeating:!0},{name:"playerJump",asset:"playerJump",numAnimFrames:8,singleFrameDuration:10,repeating:!0},{name:"playerRun",asset:"playerRun",numAnimFrames:6,singleFrameDuration:10,repeating:!0}],T=[{animation:"wave",tag:"decoration",data:[[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0],[11,0],[12,0]]},{animation:"grassFull",tag:"solid",data:[[0,4],[1,0],[2,0],[3,0],[13,0],[14,0],[15,0]]},{animation:"groundFull",tag:"solid",data:[[0,0]]},{animation:"groundSemiSolid",tag:"solid",data:[[0,1],[0,2],[0,3]]},{animation:"grassFloat",tag:"solid",data:[[6,2],[11,2]]},{animation:"grassFloatLeft",tag:"solid",data:[[5,2],[10,2]]},{animation:"grassFloatRight",tag:"solid",data:[[7,2],[12,2]]},{animation:"sign",tag:"decoration",data:[[11,3]]},{animation:"box",tag:"destructible",data:[[6,5]]}],R={startX:2,startY:4},B={assets:P,animations:I,level:T,player:R};class C{constructor(t,e,i,n=!1){this.spriteSheet=t,this.numAnimFrames=e,this.singleFrameDuration=i,this.repeating=n,this.counter=0,this.currAnimFrame=0,this.frameWidth=t.width/e,this.offscreenCanvas=new OffscreenCanvas(this.frameWidth,t.height),this.ctx=this.offscreenCanvas.getContext("2d"),this.updateSprite()}update(){this.counter+=1,this.currAnimFrame=Math.floor(this.counter/this.singleFrameDuration%this.numAnimFrames),this.updateSprite()}getSprite(){return this.offscreenCanvas.transferToImageBitmap()}hasEnded(){return this.currAnimFrame===this.numAnimFrames-1}duplicate(){return new C(this.spriteSheet,this.numAnimFrames,this.singleFrameDuration,this.repeating)}updateSprite(){this.ctx.drawImage(this.spriteSheet,this.currAnimFrame*this.frameWidth,0,this.frameWidth,this.spriteSheet.height,0,0,this.offscreenCanvas.width,this.offscreenCanvas.height)}}const k={internalWidth:512,internalHeight:256,gravity:.05,tileSize:32,gameWidth:16,gameHeight:8},L={speed:.4,width:32,height:32,jumpSpeed:2.1,boundingBox:{width:32,height:32},maxFallSpeed:2},D={width:32,height:32,boundingBox:{width:32,height:32}},r={game:k,player:L,ground:D},g=class g{constructor(t=0,e=0){this.x=t,this.y=e}add(t){return new g(this.x+t.x,this.y+t.y)}subtract(t){return new g(this.x-t.x,this.y-t.y)}multiply(t){return new g(this.x*t,this.y*t)}length(){return Math.sqrt(this.x**2+this.y**2)}normalize(){const t=this.length()||1;return new g(this.x/t,this.y/t)}};g.ZERO=new g;let l=g;class F{constructor(t,e){this.position=t,this.velocity=e,this.prevPosition=new l(t.x,t.y)}}class H{constructor(){this.up=!1,this.left=!1,this.right=!1,this.canJump=!0}}class b{constructor(t){this.size=t,this.halfSize=new l(t.x/2,t.y/2)}}class z{constructor(t=0){this.g=t}}class A{constructor(t,e,i){this.anim=t,this.width=e,this.height=i}}var h=(s=>(s[s.IDLE=0]="IDLE",s[s.RUN=1]="RUN",s[s.JUMP=2]="JUMP",s))(h||{}),u=(s=>(s[s.LEFT=0]="LEFT",s[s.RIGHT=1]="RIGHT",s))(u||{});class J{constructor(t,e){this.state=t,this.direction=e}}class O{constructor(t=0,e){this.id=t,this.tag=e,this.active=!0,this.components={}}isActive(){return this.active}getId(){return this.id}getTag(){return this.tag}destroy(){this.active=!1}getComponent(t){return this.components[t]}setComponent(t,e){this.components[t]=e}}class W{constructor(){this.numEntities=0,this.entityMap=new Map,this.entitiesToAdd=[]}update(){for(const t of this.entitiesToAdd){const e=t.getTag();this.entityMap.has(e)||this.entityMap.set(e,[]),this.entityMap.get(e).push(t)}this.entitiesToAdd=[],this.removeDestroyedEntities()}addEntity(t){const e=new O(this.numEntities++,t);return this.entitiesToAdd.push(e),e}getEntitiesByTag(t){return this.entityMap.get(t)||[]}getAllEntities(){return Array.from(this.entityMap.values()).flat()}removeDestroyedEntities(){for(const[t,e]of this.entityMap.entries()){const i=e.filter(n=>n.isActive());this.entityMap.set(t,i)}}}async function G(s){return new Promise((t,e)=>{const i=new Image;i.onload=()=>{t(i)},i.onerror=n=>{console.error(`Could not load '${s}'!`),e(n)},i.src=s})}function f(s,t,e=!1){const i=s.getComponent("transform"),n=t.getComponent("transform"),a=e?i==null?void 0:i.prevPosition:i==null?void 0:i.position,o=e?n==null?void 0:n.prevPosition:n==null?void 0:n.position,m=s.getComponent("boundingBox"),p=t.getComponent("boundingBox");if(!a||!o||!m||!p)return l.ZERO;const c=Math.abs(a.x+m.halfSize.x-o.x-p.halfSize.x),x=m.halfSize.x+p.halfSize.x-c,d=Math.abs(a.y+m.halfSize.y-o.y-p.halfSize.y),S=m.halfSize.y+p.halfSize.y-d;return new l(x,S)}class U{constructor(t,e,i){this.context=t,this.animations=e,this.level=i,this.internalWidth=r.game.internalWidth,this.internalHeight=r.game.internalHeight,this.paused=!1,this.drawBoundingBoxes=!1,this.drawTextures=!0,this.drawGrid=!1,this.run=this.run.bind(this),this.init()}run(t=0){this.paused||(this.entityManager.update(),this.handleMovement(),this.checkCollision()),this.handleAnimations(),this.render(),requestAnimationFrame(this.run)}handleInput(t){const e=this.player.getComponent("input");if(e)switch(t.key){case"a":e.left=t.type==="keydown";break;case"d":e.right=t.type==="keydown";break;case"w":e.up=t.type==="keydown";break;case"r":this.init();break;case"g":t.type==="keydown"&&(this.drawGrid=!this.drawGrid);break;case"b":t.type==="keydown"&&(this.drawBoundingBoxes=!this.drawBoundingBoxes);break;case"t":t.type==="keydown"&&(this.drawTextures=!this.drawTextures);break;case"Escape":t.type==="keydown"&&(this.paused=!this.paused);break}}init(){this.entityManager=new W,this.loadLevel(this.level)}loadLevel(t){const e=r.game.tileSize;this.player=this.entityManager.addEntity("player");const i=new F(new l(t.player.startX*e,(r.game.gameHeight-1-t.player.startY)*e),l.ZERO);this.player.setComponent("transform",i);const n=new H;this.player.setComponent("input",n),this.player.setComponent("gravity",new z(r.game.gravity));const a=this.animations.get("playerIdle");this.player.setComponent("animation",new A(a,r.player.width,r.player.height)),this.player.setComponent("boundingBox",new b(new l(r.player.boundingBox.width,r.player.boundingBox.height))),this.player.setComponent("state",new J(h.IDLE,u.RIGHT));for(const{tag:o,animation:m,data:p}of t.level)for(const[c,x]of p){const d=this.entityManager.addEntity(o);(o==="solid"||o==="destructible")&&d.setComponent("boundingBox",new b(new l(r.ground.boundingBox.width,r.ground.boundingBox.height))),d.setComponent("transform",new F(new l(c*e,(r.game.gameHeight-1-x)*e),l.ZERO)),d.setComponent("animation",new A(this.animations.get(m).duplicate(),r.ground.width,r.ground.height))}}handleMovement(){const t=this.player.getComponent("transform"),e=this.player.getComponent("input");let i=l.ZERO;if(t&&e){i=new l(t.position.x,t.position.y);const n=new l(0,t.velocity.y);e.left&&(n.x-=r.player.speed,this.player.getComponent("state").state=h.RUN,this.player.getComponent("state").direction=u.LEFT),e.right&&(n.x+=r.player.speed,this.player.getComponent("state").state=h.RUN,this.player.getComponent("state").direction=u.RIGHT),e.up&&e.canJump&&(e.canJump=!1,n.y-=r.player.jumpSpeed,this.player.getComponent("state").state=h.JUMP),n.x===0&&n.y===0&&(this.player.getComponent("state").state=h.IDLE),t.velocity=n,t.position=t.position.add(t.velocity)}for(const n of this.entityManager.getAllEntities()){const a=n.getComponent("gravity"),o=n.getComponent("transform");if(o){const m=o==null?void 0:o.position;a&&(o.velocity.y+=a.g,o.velocity.y=Math.min(o.velocity.y,r.player.maxFallSpeed)),o.position=o.position.add(o.velocity),o.prevPosition=m}}t&&(t.prevPosition=i)}checkCollision(){for(const t of this.entityManager.getEntitiesByTag("solid")){const e=f(this.player,t);if(e.x>=0&&e.y>=0){const i=f(this.player,t,!0);i.y>0&&(this.player.getComponent("transform").velocity.x=0,this.player.getComponent("transform").position.x>t.getComponent("transform").position.x?this.player.getComponent("transform").position.x+=e.x:this.player.getComponent("transform").position.x-=e.x),i.x>0&&(this.player.getComponent("transform").velocity.y=0,this.player.getComponent("transform").position.y>t.getComponent("transform").position.y?this.player.getComponent("transform").position.y+=e.y:(this.player.getComponent("transform").position.y-=e.y,this.player.getComponent("input").canJump=!0,this.player.getComponent("state").state===h.JUMP&&(this.player.getComponent("state").state=h.IDLE)))}}for(const t of this.entityManager.getEntitiesByTag("destructible")){const e=f(this.player,t);if(e.x>=0&&e.y>=0){const i=f(this.player,t,!0);i.y>0&&(this.player.getComponent("transform").velocity.x=0,this.player.getComponent("transform").position.x>t.getComponent("transform").position.x?this.player.getComponent("transform").position.x+=e.x:this.player.getComponent("transform").position.x-=e.x),i.x>0&&(this.player.getComponent("transform").velocity.y=0,this.player.getComponent("transform").position.y>t.getComponent("transform").position.y?(this.player.getComponent("transform").position.y+=e.y,t.destroy()):(this.player.getComponent("transform").position.y-=e.y,this.player.getComponent("input").canJump=!0,this.player.getComponent("state").state===h.JUMP&&(this.player.getComponent("state").state=h.IDLE)))}}}handleAnimations(){for(const t of this.entityManager.getAllEntities()){const e=t.getComponent("animation");if(!e)continue;const i=t.getComponent("state");if(i)switch(i.state){case h.IDLE:const n=this.animations.get("playerIdle");e.anim=n;break;case h.JUMP:const a=this.animations.get("playerJump");e.anim=a;break;case h.RUN:const o=this.animations.get("playerRun");e.anim=o;break}e.anim.update(),!e.anim.repeating&&e.anim.hasEnded()&&t.destroy()}}render(){this.context.fillStyle="#e0fcf8",this.context.fillRect(0,0,this.internalWidth,this.internalHeight);const t=this.entityManager.getAllEntities().filter(e=>e.getTag()!=="player").concat(this.player);for(const e of t){const i=e.getComponent("transform"),n=e.getComponent("animation");if(!(!i||!n)){if(this.drawTextures){const a=i.position.x,o=i.position.y,m=n.width,p=n.height,c=e.getComponent("state");!c||c.direction===u.RIGHT?this.context.drawImage(n.anim.getSprite(),a,o,m,p):(this.context.save(),this.context.scale(-1,1),this.context.drawImage(n.anim.getSprite(),-a,o,-m,p),this.context.restore())}if(this.drawBoundingBoxes){const a=e.getComponent("boundingBox");a&&(this.context.strokeStyle="red",this.context.strokeRect(i.position.x,i.position.y,a.size.x,a.size.y))}if(this.drawGrid){const a=r.game.tileSize;this.context.strokeStyle="grey",this.context.fillStyle="black",this.context.font="9px monospace";for(let o=0;o<r.game.gameHeight;o+=1)for(let m=0;m<r.game.gameWidth;m+=1)this.context.strokeRect(m*a,o*a,a,a),this.context.fillText(`${m},${r.game.gameHeight-o-1}`,m*a,o*a+9,a)}}}if(this.paused){this.context.fillStyle="rgba(0, 0, 0, 0.5)",this.context.fillRect(0,0,this.internalWidth,this.internalHeight),this.context.font="24px system-ui",this.context.fillStyle="white";const e="Paused",i=this.context.measureText(e);this.context.fillText(e,(r.game.internalWidth-i.width)/2,(r.game.internalHeight-24)/2+24)}}}const w=document.getElementById("canvas"),N=w.getContext("2d"),v=B,E=new Map;for(const s of v.assets){const t=await G(s.imagePath);E.set(s.name,t)}const M=new Map;for(const s of v.animations){const t=E.get(s.asset),e=new C(t,s.numAnimFrames,s.singleFrameDuration,s.repeating);M.set(s.name,e)}const y=new U(N,M,v);w.addEventListener("keydown",y.handleInput.bind(y));w.addEventListener("keyup",y.handleInput.bind(y));y.run();
